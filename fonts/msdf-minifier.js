/**
 * msdf-minifier.js
 * @author quinton-ashley
 *
 * Minifies JSON files generated by msdf-bmfont-xml
 * https://msdf-bmfont.donmccurdy.com/
 *
 * Converts the chars and kernings arrays to CSV strings
 * and removes unnecessary data.
 *
 * Font must be in the same folder as this script.
 *
 * CLI Usage: node msdf-minifier.js <font-name>
 */

const fs = require('fs');
const { Parser } = require('json2csv');

// Read input file path from command line
const inputFile = __dirname + '/' + process.argv[2] + '-msdf.json';

// Read and parse JSON file
let data = JSON.parse(fs.readFileSync(inputFile, 'utf8'));

// Convert chars array to CSV
const parser = new Parser({ delimiter: ' ' });

let chars = data.chars;

for (let char of chars) {
	delete char.index;
	delete char.chnl;
	delete char.page;
}

// Create modified JSON with CSV chars
chars = parser.parse(chars);

// handle special cases when the
// character is a double quote or backslash
chars = chars.replace('"\\"', '"\\\\"');
chars = chars.replace('""""', '"\\""');

data.chars = chars;

if (data.kernings.length) {
	data.kernings = parser.parse(data.kernings);
}

let info = data.info;
if (!info.bold) delete info.bold;
if (!info.italic) delete info.italic;
delete info.charset;
delete info.unicode;
delete info.stretchH;
delete info.smooth;
delete info.aa;
delete info.padding;
delete info.spacing;

let common = data.common;
delete common.pages;
delete common.packed;
delete common.alphaChnl;
delete common.redChnl;
delete common.greenChnl;
delete common.blueChnl;

delete data.distanceField;

// Write modified JSON back to file
fs.writeFileSync(inputFile, JSON.stringify(data));

console.log(`Minified ${inputFile}`);
